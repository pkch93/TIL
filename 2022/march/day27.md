# 2022.03.27 TIL - Mock과 테스트 취약성

- [2022.03.27 TIL - Mock과 테스트 취약성](#20220327-til---mock과-테스트-취약성)
  - [고전파 vs 런던파](#고전파-vs-런던파)
  - [의존성 유형](#의존성-유형)

일반적으로 애플리케이션에는 시스템 내부 통신과 시스템 간 통신 이라는 2가지 형태의 통신이 존재한다. 전자는 애플리케이션 내 클래스 간의 통신을 의미하는 반면 시스템 간 통신은 애플리케이션이 다른 애플리케이션을 호출하는 것을 의미한다. 따라서 시스템 내부 통신은 구현 세부사항에 해당하는 반면 시스템 간 통신은 그렇지 않다.

연산을 수행하기 위한 도메인 클래스 간의 협력은 식별할 수 있는 동작이 아니기 때문에 시스템 내부 통신은 구현 세부 사항에 해당한다.

> 식별할 수 있는 동작이란 다음 중 하나를 만족해야한다.
> 
>
> 클라이언트가 목표를 달성하는데 도움이 되는 연산을 노출해야한다.
>
> 클라이언트가 목표를 달성하는데 도움이 되는 상태를 노출해야한다.
> 
> 위에서 언급한 ‘도메인 클래스 간의 협력은 식별할 수 있는 동작이 아니다’는 API 등으로 애플리케이션을 호출하는 앱, 시스템 등이 클라이언트라고 생각했을 때를 기준으로 했을때 식별할 수 있는 동작이 아닌것으로 보인다. 따라서 외부 시스템을 호출하는 것은 시스템 기준으로 API의 목표를 이루기 위한 식별 가능한 동작이다.

시스템과 외부 애플리케이션 간의 통신 패턴을 확인할 때는 mock을 사용해도 좋다. 시스템 기준에서 식별 가능한 동작이기 때문이다. 반대로 시스템 내 클래스 간의 통신에 mock을 사용하면 테스트가 구현 세부 사항과 결합하므로 리펙터링 내성에 부정적이다.

## 고전파 vs 런던파

처음 질문 `Mock에 대한 논쟁은 계속되는데 어떤 학파의 의견을 따라야할까?` 의 답에 대해 이제는 결정을 할 수 있어보인다.

런던파는 불변 의존성을 제외한 모든 의존성에 Mock 사용을 권장한다. 그리고 시스템 내 통신과 시스템 간 통신을 구분짓지 않는다. 반면 고전파는 공유 의존성에 대해서만 Mock 사용을 허용한다.

런던파를 따르게 되면 결국 테스트에 구현 세부 사항 결합이 많아지므로 테스트에 리펙터링 내성을 찾기 어려워질 수 있다. 고전파는 테스트 간 공유 의존성만 교체하자고 주장하므로 리펙터링 내성을 런던파보다는 더 얻을 수 있다.

## 의존성 유형

의존성 유형은 다음 3가지로 나눌 수 있다.

- 공유 의존성
- 프로세스 외부 의존성
- 비공개 의존성

고전파는 공유 의존성을 피할 것을 권고한다. 테스트가 실행 컨텍스트를 서로 방해하고 테스트 간 병렬 처리를 할 수 없기 때문이다. 단위 테스트에서 공유 의존성은 테스트 실행시 해당 의존성을 새 인스턴스로 생성하여 테스트 간 독립성을 유지할 수 있다. 

데이터베이스와 같은 공유 의존성의 경우는 인스턴스화하기 힘들다. 이런 의존성의 경우는 Mock과 Stub으로 교체할 수 있다. 다만, 모든 프로세스 외부 의존성이 Mock과 Stub을 사용하라는 것은 아니다. 애플리케이션을 통해서만 접근할 수 있다면 이러한 의존성과의 통신은 시스템에서 식별할 수 있는 동작이 아니다. 클라이언트 입장에서는 관심이 없는 동작이기 때문이다. 이 경우에는 Mock으로 검증해서는 안된다.

데이터베이스 뿐만 아니라 외부 시스템에 대한 프록시 역할을 하고 클라이언트가 직접 접근이 불가능한 경우에도 이는 구현 세부사항이 된다. 이 경우도 Mock으로 검증해서는 안된다.
