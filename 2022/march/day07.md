# 2022.03.07 TIL - 단위 테스트

단위 테스트는 다음과 같이 3가지 특성을 만족한다.

- 작은 코드 조각을 검증
- 빠르게 수행
- 격리된 방식으로 처리하는 자동화된 테스트

> 마지막 `격리된 방식으로 처리하는 자동화된 테스트`에 대한 의견차이가 Classcist와 Mockist의 견해 차이를 만든다.
 
만약 위 특성 중 하나라도 만족하지 못한다면 단위 테스트라고 할 수 없다. 보통 단위 테스트가 아니라면 통합 테스트라고 정의한다.

## AAA와 Given-When-Then (단위 테스트 구조)

단위 테스트를 정의하는 방법으로 AAA `Arrange 준비 - Act 실행 - Assert 검증`와 Given-When-Then `Given 준비 - When 실행 - Then 검증` 방식이 있다.

> 사실 AAA와 Given-When-Then은 준비, 실행, 검증으로 구성되어있어 차이는 없다. AAA는 프로그래머에게 익숙한 구조이고 Given-When-Then은 비기술자에게 익숙한 방식으로 소개한다.

테스트 작성할 때는 준비 구절부터 시작하는 것이 자연스럽다. 실행하기 전 현재 상태의 테스트 픽스처를 정의하여 이 테스트가 어떤 상태에서 실행하는 것인지 확인할 수 있도록 작성하는 것이 테스트 가독성에도 유리하다. 이 다음에 실제 코드를 실행하고 검증하는 과정이 이뤄진다.

만약 TDD로 코드를 작성한다면 검증 구문부터 테스트를 작성할수도 있다. 기대하는 동작으로 윤곽을 잡은 다음에 동작을 구현하기 위해 어떻게 개발할지 고민하면서 준비, 실행 과정을 정의할 수 있다.

준비 - 실행 - 검증 구절에서 가장 큰 구절은 준비 구절이다. 단, 준비 구절도 너무 큰 경우에는 테스트 가독성을 해친다. 보통 테스트 픽스처를 만드는데 많은 라인을 소모하기 때문에 같은 클래스 내에 private 메서드나 별도의 테스트 팩터리 클래스를 정의하는 것도 도움이 된다.

> 준비 구절에서 테스트 픽스처를 만드는데 도움이 되는 패턴은로 [Object Mother](https://martinfowler.com/bliki/ObjectMother.html)와 [Test Data Builder](https://www.arhohuttunen.com/test-data-builders/) 패턴이 있다.


실행 구절은 보통 한 줄로 표시한다. 실행 구절이 2줄 이상이라면 sut 공개 API에 문제가 있다는 뜻이 된다.

이 문제는 **캡슐화를 위반하는 것**이다. 캡슐화를 위반하여 불변식을 위반하게 되고 잠재적인 버그를 유발할 수 있는 요인이 된다. 이를 해결하기 위해서 코드 캡슐화를 지키는 방식으로 구현해야한다.

### 여러 준비 - 실행 - 검증 구절 피하기

하나의 단위 테스트에서는 여러 준비, 실행, 검증 과정을 피해야한다.

![](https://user-images.githubusercontent.com/30178507/157045284-7ecbda5f-fbe9-4b34-8fdc-ef7e40b2b40c.png)

위와 같은 예시가 여러 구문이 있는 예시이다. 위 예시에서는 실행 후에 추가 실행 - 검증 구문이 있다. 검증 구절로 구분된 여러 개의 실행 구절이 있는 것은 한 테스트에서 여러 개의 동작 단위를 검증하는 테스트를 의미한다.

> 위와 같이 여러 구절의 테스트는 단위 테스트가 아니라 통합 테스트라고 칭한다. 

실행이 하나면 테스트가 단위 테스트 범주에 있도록 보장하고 간단하고, 빠르면서 이해가 쉽도록 도와준다. 따라서 단위 테스트에 여러 실행 - 검증 구절이 존재한다면 리팩터링 대상이다.

### 테스트 내 if문 피하기

단위 테스트에서의 if문도 테스트 안티 패턴이다. **테스트는 분기가 없는 일련의 단계를 테스트해야한다.**

테스트에서 if문은 한 테스트가 너무 많은 것을 검증한다는 의미가 된다. 이는 테스트를 이해하기 어렵게 만든다. 따라서 분기를 없애고 여러 테스트로 나눠야한다.

## 단위 테스트 명명

단위 테스트 이름에는 엄격한 규칙을 따를 필요는 없다. 엄격한 규칙은 테스트의 의미를 다 표현하지 못하도록 만들 수 있다. 테스트 이름은 비개발자에게 설명하는 것처럼 명명하는 것이 가장 합리적이다.

테스트 이름을 지을 때 중요한 것 중 하나는 테스트 이름에 SUT 메서드 이름을 포함하지 않는 것이다. SUT 메서드 이름은 리팩터링을 통해서 언제든지 변경할 수 있다. 만약 테스트 이름에 메서드 이름이 포함되어있다면 이 변경이 테스트 이름에도 같이 반영이 되어야하는데 이를 반영하지 못할 가능성이 높다.

테스트 메서드가 테스트 이름에 포함된다면 코드의 세부사항과 테스트 간의 결합도가 높아지는 문제가 되므로 테스트 이름에 SUT 메서드 명을 포함하지 않아야한다.

## 참고

[단위테스트 3장 - 단위 테스트 구조](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9791161755748)