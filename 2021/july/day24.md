# 2021.07.24 TIL - Amazon Redshift

Amazon Redshift docs: [https://docs.aws.amazon.com/ko_kr/redshift/latest/gsg/getting-started.html](https://docs.aws.amazon.com/ko_kr/redshift/latest/gsg/getting-started.html)

Amazon Redshift 아키텍처 및 모범사례: [https://www.youtube.com/watch?v=w3-P6s97ZsE](https://www.youtube.com/watch?v=w3-P6s97ZsE)

![](https://user-images.githubusercontent.com/30178507/126869682-06c3c24d-cf85-4763-89a9-ac719976f4fa.png)

Amazon Redshift는 완전 관리형 페타바이트 `PB` 급 데이터 웨어하우스 `DW` 서비스이다.

> 데이터 웨어하우스란 정보에 입각한 의사 결정을 내릴 수 있도록 데이터베이스에 축적된 데이터를 공통의 형식으로 변환해서 관리하는 데이터베이스를 말한다.

보통의 데이터베이스가 트랜잭션 데이터 처리에 초점을 맞추는 반면 데이터 웨어하우스는 데이터 쿼리 및 분석에 초점을 맞추며 트랜잭션 데이터에서 추출한 히스토리 데이터를 비롯해 다양한 소스에서 가져온 의사결정 데이터를 포함한다. 때문에 데이터의 소비 주체라고 할 수 있으며 온라인 분석 처리 시스템 `OLAP, Online Analytical Processing` 이라고 부르기도 한다.

데이터 웨어하우스는 읽기 중심의 데이터 처리 시스템으로 쓰기 및 업데이트 능력에 비해 읽기 처리 능력이 월등히 좋다. 때문에 트랜잭션 시스템에 큰 영향을 주지 않고 각종 분석 업무를 높은 성능으로 처리할 수 있다.

또한 데이터 웨어하우스와 같은 OLAP 데이터베이스는 OLTP에 비해 배치 프로세스, 스케줄 잡과 같은 기능으로 다양한 소스에서 데이터를 효과적으로 수집할 수 있는 기능을 제공한다. 데이터 웨어하우스 환경에는 데이터 추출, 변환, 로딩의 전 과정을 일컴는 ETI 솔루션, 통계 분석, 리포트 작성, 데이터 마이닝, 클라이언 트 분석 도구 등이 포함되고, 데이터 수집, 행동 가능 정보로의 변환, 비즈니스 의사 결정자에게 제공하기 위한 애플리케이션이 포함된다.

Amazon Redshift는 TB당 1,000 달러 수준의 가격으로 타 경쟁 제품에 비해 1/10 수준의 가격에 서비스를 제공한다.

> Federated Query `연합 쿼리` 기능으로 Amazon Aurora나 RDS의 데이터를 쿼리하여 로딩할 수 있다. 다만, 이 기능은 Preview Release인 것을 감안해야한다.

## Amazon Redshift 아키텍처

![](https://user-images.githubusercontent.com/30178507/126869683-27f728e0-68b6-4265-9ce2-a425663ede25.png)

출처: [https://www.youtube.com/watch?v=w3-P6s97ZsE](https://www.youtube.com/watch?v=w3-P6s97ZsE)

Amazon Redshift는 리더 `Leader` 노드 1개와 1개 이상의 컴퓨팅 노드로 구성된다. 리더노드는 애플리케이션의 SQL 엔드포인트 역할을 하며 데이터베이스로서의 기능 및 병렬적인 SQL 처리 업무를 조정하는 역할을 담당한다.

Redshift는 PostgreSQL을 기반으로 구현되어 있으며 Redshift에 추가된 메타데이터 테이블도 리더 노드에 존재하기 때문에 PostgreSQL 커넥터를 통해 애플리케이션에서 연결가능하다.

리더 노드 아래에는 컴퓨팅 노드가 위치하며 최대 128개까지 생성가능하다. 컴퓨팅 노드는 리더 노드가 받은 요청을 실제로 처리하는 역할을 담당한다. 실행방식은 다음과 같다.

1. 애플리케이션 또는 SQL 클라이언트가 쿼리를 실행
2. 실행 쿼리는 리더 노드에 전달. 리더 노드는 쿼리를 파싱해 실행 계획을 수립한다.
3. 리더 노드는 어떤 컴퓨트 노드가 이번 쿼리를 처리할지 결정하고, 다수의 컴퓨팅 노드에 쿼리 잡을 배분한다.
4. 컴퓨팅 노드가 쿼리 잡을 처리하고 결과값을 리더 노드에게 전달한다.
5. 리더 노드는 결과값을 취합해 애플리케이션 또는 클라이언트에게 전달한다.

즉, 리더 노드는 데이터 암호화, 데이터 압축, 라우팅, 백업, 복원 등의 데이터베이스 본연의 기능을 담당하고 컴퓨팅 노드는 리더 노드에게서 받은 잡을 수행하는 역할로 아키텍처가 구성되어 있다. 컴퓨팅 노드는 CPU의 갯수에 따라 슬라이스가 배정되는데 이 슬라이스가 쿼리 수행의 주체가 된다.

컴퓨팅 노드는 Amazon S3 등의 서비스와는 바로 소통이 가능하므로 S3에서 컴퓨팅 노드로 바로 이동시킬 수 있다.

Redshift 클러스터는 싱글노드 및 멀티노드 클러스터, 두 가지 타입이 있다. 싱글 노드 클러스터는 리더 노드와 컴퓨팅 노드를 하나의 노드가 모두 맡아서 처리히는 방식이며, 해당 노드가 다운되면 애플리케이션 전체가 다운되므로 스냄 삿을 이용해서 해당 클러스터를 복원해야한다. 따라서 싱글 노드 클러스터는 상용화 환경이 아닌, 테스트 및 개발 환경에서 사용하는 것을 권장한다.

멀티 노드 클러스터에서 리더 노드는 컴퓨팅 노드와 분리되어 있으며, 클러스터별로 하나의 리더 노드만 존재한다. 클러스터 생성 시 사용자는 컴퓨팅 노드의 수를 지정 할 수 있으며, 멀티 노드 클러스터는 해당 숫자만큼의 컴퓨팅 노드를 생성한다. 예를 들어, 클러스터는 생성 시 세 개의 노드를 입력하면 하나의 리더 노드와 세 개의 컴퓨팅 노드가 있는 클러스터가 생성된다.

멀티 노드 클러스터에서 데이터는 중복 구현을 위해 컴퓨팅 노드에서 자동으로 복제 되므로 특정 컴퓨트 노드가 다운돼도 스냅삿으로 복구할 필요가 없다. 컴퓨팅 노드가 실제로 다운되면 다른 컴퓨트 노드가 이를 대체하고, 클러스터는 자동으로 데이터를 새로운 컴퓨팅 노드로 전송한다. 상용화 워크로드에는 이와 같은 중복 구현 안전장치가 적용돼야 한다.

Redshift 클러스터에서 선택할 수 있는 인스턴스 타입으로는 SSD 드라이브 기반의 인스턴스와 기존의 전자기식 하드 드라이브 기반의 인스턴스가있다. 좀더 높은 성능이 필요한 경우 SSD 드라이브 기반을 선택하고, 대량의 워크로드 처리가 필요한 경우 HDD 기반의 인스턴스 사용한다.

## Amazon Redshift 네트워킹

Amazon Redshift도 EC2, RDS처럼 VPC 내에서 실행 될 수 있다. 따라서 VPC를 구성하여 Redshift의 데이터를 보호할 수 있다. 단, 접근은 리더 노드에만 해당되고 컴퓨팅 노드는 별도의 VPC에서 생성되기 때문에 사용자가 접근은 불가능하다.

Amazon Redshift는 Enhenced VPC Routing 옵션을 제공하여 이 옵션을 선택하면 Amazon VPC 기반으로 클러스터와 데이터 저장소간 데이터 트래픽이 라우팅되도록 지원한다. 만약 Enhenced VPC Routing을 사용하지 않으면 Redshift는 AWS 네트워크 내 다른 서비스로의 트래픽을 포함한 모든 트래픽을 인터넷을 거쳐 라우팅한다.

## Amazon Redshift 보안

Redshift는 RDBMS 중 하나이므로, 슈퍼유저 또는 유저 권한을 지닌 데이터베이스 유저를 생성해야한다. 즉, Redshift도 PostgreSQL 엔진을 기반으로 하기 때문에 데이터베이스 유저를 통한 보안을 이룰 수 있다.

데이터베이스 슈퍼유저는 데이터베이스 유저 또는 다른 슈퍼유저를 생성할 수 있다. 데이터베이스 유저는 권한에 따라 Redshift에서 데이터베이스 객체를 생성할 수 있다.

Redshift에서 데이터베이스는 하나 이상의 스키마를 지닐 수 있으며, 각 스키마는 다시 테이블과 객체를 지니게 된다. Redshift 데이터베이스의 기본 스키마 네임은 Public이며, 처음 Redshift 클러스터를 생성할 때는 마스터유저네임 및 패스워드를 입력해야 한다. 이때 마스터 유저네임은 데이터베이스에 로그인할 수 있는 슈퍼 유저를 가리키며, 마스터 유저 계정은 삭제 불가능하다.

Redshift 서비스를 사용하기 위해, IAM 유저, 롤, 그룹 등을 포함한 IAM 정책을 생성 할 수 있으며, Redshift 관리형 정책을 통해 Redshift를 어드민 또는 read-only 권한으로 접근할 수 있고, 사용자가 직접 커스텀 정책을 만들어서 세분화된 권한을 부여 할 수 있다.

## Amazon Redshift 백업 및 복구

Amazon Redshift는 클러스터 스냅샷 형태로 Amazon S3에 자동으로 백업한다. 기본적으로 8시간마다 또는 5GB의 블록이 추가될 때 중 먼저 오는 경우를 기준으로 스냅샷을 생성한다.

클러스터를 생성하면 기본적으로 자동 스냅샷 기능이 활성화되며 자동 스냅샷 일정은 커스텀하게 변경할 수 있다. 이때 cron 식을 이용해서 정의도 가능하다.

수동으로 언제든지 Amazon Redshift 클러스터의 스냅샷을 생성할 수 있다. 기본적으로 수동 스냅샷은 클러스터가 삭제되더라도 무제한으로 보관한다.

스냅샷은 기본적으로 모든 사용자 정의 영구 테이블을 포함하는데 만약 백업해도 되지 않는 테이블에 대해서는 제외하여 Amazon S3 스토리지 공간을 줄일 수 있다.

스냅샷은 S3 스토리지의 공간을 사용하기 때문에 저장하는만큼 비용이 발생한다. 따라서 더이상 해당 스냅샷이 필요하지 않는 경우에는 삭제해야한다. 기본적으로 Amazon Redshift의 스냅샷은 보존 기간이 끝날때 이를 삭제한다.

스냅샷을 통해 전체 데이터베이스 복원이 가능하며 필요하다면 테이블 단위의 데이터 복원도 가능하다. 그리고 크로스 리전 스냅샷 기능을 통해 다른 리전에 스냅샷을 통해 클러스터 복원도 지원한다.