# 2021.07.09 TIL - ELB와 Target Group 사용해보기

- [2021.07.09 TIL - ELB와 Target Group 사용해보기](#20210709-til---elb와-target-group-사용해보기)
  - [대상 그룹 지정하기](#대상-그룹-지정하기)
  - [ELB 사용해보기](#elb-사용해보기)
    - [리스너](#리스너)
    - [가용 영역](#가용-영역)
  - [다중 AZ 사용하기](#다중-az-사용하기)

## 대상 그룹 지정하기

대상 그룹은 EC2 > 대상 그룹 `Target Group` 탭에서 생성할 수 있다.

![](https://user-images.githubusercontent.com/30178507/125089296-3ed47b80-e109-11eb-8c89-7222c0fdbbf8.png)

위 화면을 보면 대상의 타입을 인스턴스, IP 주소, 람다함수 중 하나로 지정할 수 있다. 대상 그룹의 이름과 프로토콜, 포트를 지정한다. 만약 HTTP나 HTTPS가 프로토콜이라면 프로토콜의 버전도 저장할 수 있다.

![](https://user-images.githubusercontent.com/30178507/125089299-3f6d1200-e109-11eb-90e4-a4f54b91078f.png)

대상 그룹에서 로드벨런서의 헬스 체크 기능도 설정할 수 있다. Application Load Balancer는 HTTP, HTTPS 프로토콜 헬스 체크를 지원하며 Network Load Balancer는 TCP 헬스 체크를 지원한다.

헬스 체크를 통해 특정 대상에 문제가 생긴다면 트래픽을 다른 정상 인스턴스로 옮겨주며 다시 정상 상태로 돌아온다면 로드 밸런서가 트래픽을 전달한다.

이렇게 지정하고 다음 단계에서는 대상 그룹에 들어갈 인스턴스를 지정할 수 있다.

> 인스턴스 지정은 대상 그룹의 대상 타입이 인스턴스일 경우에만 지정한다.
IP 주소라면 IP주소를 람다 함수라면 람다를 지정한다.

![](https://user-images.githubusercontent.com/30178507/125089304-409e3f00-e109-11eb-8f71-57d0ccb9052c.png)

위 설정도 모두 마치고 생성을 누르면 대상 그룹이 생성된다.

## ELB 사용해보기

ELB는 EC2 > 로드 밸런서 탭에서 생성이 가능하다.

![](https://user-images.githubusercontent.com/30178507/125089313-4136d580-e109-11eb-977e-0b11353e22ab.png)

처음에는 로드밸런서의 종류를 선택한다. 대부분 많이 사용하는 Application Load Balancer를 선택한다.

![](https://user-images.githubusercontent.com/30178507/125089321-42680280-e109-11eb-95fc-a21b1fdcfad8.png)

선택을 완료하면 위와 같이 로드밸런서 설정 화면이 나타난다.

### 리스너

리스너는 트래픽이 유입되는 로드 밸런서 리스너의 연결 부분에 대한 프로토콜과 포트를 정의한다.

Application Load Balancer에서는 HTTP, HTTPS 프로토콜을 지원하며 Network Load Balancer에서는 TCP를 지원한다. 포트는 1부터 65535까지의 포트를 지원한다.

### 가용 영역

Load Balancer에서 활성화할 가용영역을 지정한다. AZ당 하나의 서브넷만 지정이 가능하며 가용성을 위해서 2개 이상의 AZ 지정을 추천한다.

위 리스너와 가용영역을 지정하면 기본 지정은 완료되었다. 만약 HTTPS 프로토콜과 같이 보안 프로토콜을 사용하고 있다면 다음 보안 설정 구성 단계에서 인증서 등록이 필요하다.

다음 보안 그룹 설정을 하고 라우팅 구성을 해주어야한다. 라우팅 구성은 ELB가 요청을 라우팅할 대상 그룹을 설정하는 것으로 이 단계에서 새롭게 대상 그룹을 만들수도 있고 기존 대상 그룹을 설정할수도 있다.

## 다중 AZ 사용하기

기본적으로 ELB 인스턴스는 다중 AZ 환경에 구현되어 있다. 사용자가 다중 AZ에 애플리케이션을 배포하지 않더라도 ELB는 기본적으로 다중 AZ에 배포한다. 단, ELB 구성에서 가용영역 설정시 하나의 AZ만 사용하도록 만들 수 있긴한데 최소 2개 이상의 가용영역을 사용할 것을 추천한다.

다중 AZ 사용시 가끔 문제가 나타나곤 하는데, 대표적으로 자바 기반 애플리케이션 이 실행될 때 몇 가지 이슈가 나타날 수 있다. 자바 기반 애플리케이션은 DNS에 있는 서버 IP 주소를 임시 저장하는데 `DNS Cache`, 이 때문에 매번 동일한 인스턴스로 트래픽을 재전송하는 문제가 생기곤 한다. 이는 워크로드에 대한 적절한 분배가 안된 탓에인스턴스 용량의 균형이 맞지 않아서 발생하는 현상으로 크로스 존 로드 밸런싱으로 해결할 수 있다.

크로스 존 로드 밸런싱은 처리 요청을 다중 AZ 간에 균등하게 분배하는 것이며, Application Load Balancer의 기본 기능이므로 사용자가 수동으로 설정할 필요는 없다. Network Load Balancer의 경우 각 로드 밸런서 노드는 해당 AZ에 등록된 타깃으로만 트래픽을 배분한다. 이와 같은 장점을 지닌 크로스 존 로드 밸런싱에 대한 별도의 이용 요금은 없으며, 다중 AZ 환경에서 ALB를 사용할 때 편리하게 이용할 수 있다.

단, 주의할 점은 크로스 존 로드 밸런싱은 AZ 레벨이 아닌 타겟 레벨에서 이뤄진다는 점이다. 예를 들어, 첫 번째 AZ에서 실행 중인 한 개의 인스턴스와 두 번째 AZ에서 실행 중인 세 개의 인스턴스가 있을 때, ALB를 이용해서 두 AZ 에 있는 총 네 개의 타깃을 하나로 묶을 수 있다. 즉, 크로스 존 로드 밸런싱을 이용하변 인스턴스 간에 워크로드가 균등하게 배분되는 것이지 두 개의 AZ 간 에 균등하게 배분되는 것은 아니며, 결과적으로 모든 인스턴스에게 동일한 워크로드가 전달된다.
