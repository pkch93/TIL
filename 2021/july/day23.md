# 2021.07.23 TIL  - Amazon Aurora

- [2021.07.23 TIL  - Amazon Aurora](#20210723-til----amazon-aurora)
  - [Amazon Aurora 스토리지 및 안전성](#amazon-aurora-스토리지-및-안전성)
    - [Amazon Aurora 클러스터 볼륨과 스토리지](#amazon-aurora-클러스터-볼륨과-스토리지)
    - [Amazon Aurora의 안정성](#amazon-aurora의-안정성)
  - [Amazon Aurora의 고가용성](#amazon-aurora의-고가용성)
    - [DB 인스턴스 컴퓨팅 고가용성](#db-인스턴스-컴퓨팅-고가용성)
    - [데이터 고가용성](#데이터-고가용성)
    - [AWS 리전 간 고가용성](#aws-리전-간-고가용성)

Amazon Aurora docs: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/CHAP_AuroraOverview.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/CHAP_AuroraOverview.html)

Amazon Aurora는 클라우드에 최적화된 MySQL 및 PostgreSQL 호환 관계형 데이터베이스이다. 완전 분산형 및 자가 진단형 스토리지 시스템을 통해 성능 및 신뢰성을 보장하며 고가용성을 제공한다. 기본적으로 클러스터링과 복제를 자동화하고 표준화한다.

> MySQL의 최대 5배, PostgreSQL의 최대 3배의 처리량 성능을 제공한다.

앞서 언급했듯이 MySQL과 PostgreSQL 데이터베이스 엔진을 지원한다. MySQL의 경우 InnoDB를 사용하는 5.6과 5.7 버전과 호환되는 반면 PostgreSQL은 9.7, 10.12, 11.7 버전과 호환된다.

Amazon Aurora DB 클러스터는 하나 이상의 DB 인스턴스와 이 DB 인스턴스의 데이터를 관리하는 클러스터 볼륨으로 구성된다. Aurora 클러스터 볼륨은 다중 AZ를 아우르는 가상 데이터베이스 스토리지 볼륨으로 각 가용영역에 DB 클러스터 데이터의 사본이 있다.

![](https://user-images.githubusercontent.com/30178507/126869684-40ddfc11-f346-44f7-a3bf-e3e736fbf473.png)

위 그림은 Aurora DB 클러스터에 속하는 Primary 인스턴스와 Replica 인스턴스 사이의 관계를 보여준다. 여러 AZ를 아우르는 스토리지 볼륨 위에 각 AZ에 Primary와 Replica 인스턴스가 동작하는 구조이다.

서로 다른 AZ에 있는 여섯 개의 서로 다른 스토리지 노드로 분리된 스토리지 레이어에 자동으로 데이터를 복제히는데 이는 별도의 비용없이 데이터를 여섯번 미러링 한다는 측면에서 의미가 크다. 이와 같은 모든 데이터 미러링은 동기적으로 진행되므로 데이터 손실이 발생하지 않는다. 또 Amazon Aurora는 멀티 스토리지 노드에서의 데이터 가용성을 보장하기 위해 읽기 및 쓰기를 위한 쿼럼 시스템을 사용한다. 동시에, 모든 데이터는 S3에 지속적으로 백업돼 신뢰성 및 가용성을 제공한다.

Aurora 클러스터의 스토리지는 최대 128TB까지 지원하며 필요에 따라 자동으로 커진다. Amazon RDS와 마찬가지로 Replica는 최대 15대까지 지원한다.

## Amazon Aurora 스토리지 및 안전성

### Amazon Aurora 클러스터 볼륨과 스토리지

Amazon Aurora는 Aurora SSD를 사용하는 단일 가상 볼륨인 클러스터 볼륨에 저장된다. 클러스터 볼륨은 동일한 AWS 리전에 속한 세 가용 영역의 데이터 사본으로 구성된다. 이렇게 가용 영역에서 자동으로 복제가 되기 때문에 데이터 손실 가능성을 줄이고 내구성을 높여준다. 특히 장애 조치 중에도 데이터 사본이 이미 다른 AZ에 존재하기 때문에 DB 인스턴스에 대한 요청을 계속해서 처리할 수 있다.

클러스터 볼륨에는 사용자 데이터, 스키마 객체, 메타 데이터 `시스템 테이블, 바이너리 로그 등`가 포함되어있다.

Aurora 스토리지는 데이터 용량이 늘어날수록 Aurora 클러스터 볼륨도 자동으로 확장된다. Aurora 클러스터 볼륨의 최대 크기는 128TB까지 증가할 수 있고 자동 조정은 스토리지 하위 시스템에 의해 이뤄진다.

### Amazon Aurora의 안정성

Aurora는 안정성, 내구성, 내결함성을 고려하여 설계되었다. Aurora DB 클러스터는 Aurora 복제본을 추가해서 다른 AZ에 배포하는 등의 방법으로 가용성을 높이도록 설계가능하다.

- 스토리지 자동 복구

    Amazon Aurora는 3개의 가용 영역에 여러 개의 복사본을 보관하고 있기 때문에 디스크 결함으로 인한 데이터 손실 가능성을 최소화한다. 만약 디스크 볼륨 세그먼트에 결함이 감지되면 자동으로 해당 디스크 볼륨 세그먼트를 복구한다.

- 유지 가능한 캐시 워밍

    Aurora는 전원이 꺼진 데이터베이스를 가동하거나 결함 발생 이후 다시 시작할 때 버퍼 풀 캐시를 워밍한다. 다시 말하면 인메모리 페이지 캐시에 저장된 기존 공통 쿼리 페이지를 이용하여 버퍼 풀을 미리 로드한다.

    참고로 Aurora 페이지 캐시는 데이터베이스가 아닌 별도의 프로세스로 관리되므로 데이터베이스와는 상관없이 유지된다. 이 때문에 데이터베이스에 결함이 생기더라도 메모리에는 페이지 캐시가 남아있다.

- 충돌 복구

    Aurora은 거의 순간적으로 충돌에서 복구하고 바이너리 로그없이 애플리케이션 데이터를 계속 제공하도록 설계되어있다. Aurora은 병렬 스레드에서 비동기 방식으로 충돌 복구를 실행하므로 충돌 직후에도 데이터베이스를 열어두고 사용할 수 있다.

    Aurora는 DB 클러스터 내에서 데이터를 복제하거나 특정 시정 복원 `PITR`을 수행하기 위해 바이너리 로그를 필요로하지 않는다. 따라서 Aurora MySQL 엔진을 사용할 때는 외부 복제가 필요하지 않는다면 `binlog_format`을 `OFF`로 설정해서 바이너리 로깅을 비활성화하는 것이 좋다.

## Amazon Aurora의 고가용성

Aurora는 컴퓨팅 `DB 인스턴스`과 데이터 `스토리지`를 분리하여 DB 인스턴스를 이용할 수 없는 경우에도 데이터를 안전하게 유지할 수 있다.

### DB 인스턴스 컴퓨팅 고가용성

Aurora DB 클러스터는 최대 15개의 Replica를 가질 수 있다. Replica는 Reader 인스턴스로 사용되며 이를 통해 Writer `Master, Primary` 인스턴스의 부하를 줄여줄 수 있다.

만약 기본 인스턴스가 문제에 장애가 발생하여 다운되는 경우 Replica 중에 하나가 기본 인스턴스의 역할을 수행한다. 이를 **failover**라고 한다. 이를 통해 Aurora는 내결함성도 갖춘다.

### 데이터 고가용성

기본 DB 인스턴스에 데이터가 기록되면 Aurora에서 가용 영역의 데이터를 클러스터 볼륨과 연결된 6개의 스토리지 노드에 동기적으로 복제한다. 이를 통해 데이터 중복을 제공하고, I/O 중지를 없애고, 시스템 백업 중에 지연 시간 스파이크를 최소화한다. DB 인스턴스를 고가용성으로 실행하면 계획된 시스템 유지 관리 중 가용성을 향상시킬 수 있으며, 데이터베이스에서 오류 및 가용 영역 중단이 일어나는 것을 방지하는 효과가 있다.

### AWS 리전 간 고가용성

여러 AWS 리전 간의 고가용성을 위해 Aurora 글로벌 데이터베이스를 설정할 수 있다. 각 Aurora 글로벌 데이터베이스는 여러 AWS 리전에 걸쳐 있으므로 지연 시간이 짧은 글로벌 읽기 및 AWS 리전 간의 중단으로부터 재해 복구를 활성화한다. Aurora는 기본 AWS 리전에서 각 보조 리전으로 모든 데이터 및 업데이트 복제를 자동으로 처리한다.