# 2021.07.22 TIL - AWS RDS `Amazon Relational Database Service`

- [2021.07.22 TIL - AWS RDS `Amazon Relational Database Service`](#20210722-til---aws-rds-amazon-relational-database-service)
  - [RDS 고가용성](#rds-고가용성)
  - [RDS 확장성](#rds-확장성)
    - [RDS 인스턴스 타입 변경 `스케일 업 / 스케일 다운`](#rds-인스턴스-타입-변경-스케일-업--스케일-다운)
    - [Reader Replica](#reader-replica)
  - [RDS 보안](#rds-보안)
    - [암호화](#암호화)
    - [암호화 주의사항](#암호화-주의사항)
  - [백업, 복구, 스냅샷](#백업-복구-스냅샷)
  - [모니터링](#모니터링)
    - [퍼포먼스 인사이트](#퍼포먼스-인사이트)

Amazon RDS docs: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/Welcome.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/Welcome.html)

AWS는 관계형 데이터베이스 호스팅 및 관리 서비스인 Amazon RDS `Amazon Relational Database Service`를 제공한다. Amazon RDS에서 사용할 수 있는 RDBMS는 다음과 같다.

- Aurora MySQL
- Aurora Postgresql
- Oracle
- SQL Server
- MySQL
- Postgresql
- MariaDB

Amazon RDS는 완전 관리형 서비스이므로 데이터베이스를 구성하기 위한 인프라 설정은 AWS에서 알아서 해준다. 또한 사용한 만큼 및 프로비저닝한만큼의 비용, I/O 요청 횟수, 백업 스토리지, 데이터 유입 유출 전송량 등의 사용량을 기준으로 비용을 지불한다.

다만, 이용에 제약이 따르는 부분도 존재한다. RDS에서 지원하는 MySQL, MariaDB, PostgreSQL, Oracle, 및 Microsoft SQL Server는 EBS를 사용하는데 범용 SSD를 사용이나 프로비저닝된 IOPS 스토리지를 사용하느냐에 따라 용량이 달라진다. 보통 MariaDB, MySQL, Oracle 및 PostgreSQL 인스턴스는 64TB까지 사용가능하다. 용량 이외에도 사용자가 RDS를 호스팅하는 운영체제에 접근할 수 없으며 운영체제 관련 수정을 할 수 없다.

## RDS 고가용성

Amazon RDS는 다중 AZ 배포를 통해 고가용성과 장애 조치 기능을 지원한다.

> 단, SQL Server 인스턴스의 경우 데이터베이스 미러링 또는 상시 가동 가용성 그룹을 사용한다.

[SQL Server의 다중 AZ 배포 참고](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/USER_SQLServerMultiAZ.html)

RDS는 자동으로 서로 다른 가용 영역에 동기식 예비 복제본을 프로비저닝하고 유지한다. 기본 데이터베이스 `primary, master`는 가용 영역에서 예비 복제본으로 동기식으로 복제되어 데이터 이중화를 제공하고 I/O 중지를 제거하며 시스템 백업 시 지연 시간 스파이크를 최소화한다.

스텐바이 데이터 베이스는 애플리케이션이 실행되고 있는 기본 데이터베이스가 셧다운되는 상황을 대비하여 가동 기능 상태에서 대기한다. 만약 기본 데이터베이스가 장애 상태가 된다면 대기 상태의 데이터베이스를 가동한다.

고가용성을 위해 RDS 인스턴스를 생성하기 위해서는 다중 AZ를 지정하여 생성할 수 있다. 이미 생성된 RDS 인스턴스도 다중 AZ 옵션을 활성화하여 변경할 수 있다.

> 다중 AZ를 사용할수도 있지만 다중 AZ 설정이 필요없다면 `ex. 개발환경` 싱글 AZ 배포를 통해, 즉, 다중 AZ 옵션을 선택하지 않고 생성할 수 있다.

당연히 단일 AZ 배포 RDS에 비해 다중 AZ 배포 RDS의 비용이 더 크다.
[RDS 비용 참고](https://aws.amazon.com/ko/rds/mysql/pricing/)

## RDS 확장성

RDS는 사용자가 늘어나고 줄어듬에 따라 인스턴스의 타입을 늘리고 줄이는 스케일 업, 스케일 다운을 지원하고 마스터 슬레이브 방식으로 Reader Replica를 두어 read-only 쿼리의 경우 Reader로 분산하여 마스터 데이터베이스 인스턴스의 부하를 줄여줄 수 있다.

### RDS 인스턴스 타입 변경 `스케일 업 / 스케일 다운`

RDS의 인스턴스 타입 변경은 AWS 콘솔에서 손쉽게 가능하다. 다만, 타입 변경시 약간의 순단이 발생할 수 있으므로 이에 대한 확인 및 조치가 필요하다.

만약 여러개의 Reader Replica를 가지고 있는 형태라면 Reader의 인스턴스 타입을 먼저 변경한 후에 Writer `Master` 인스턴스를 페일오버한 후 Reader를 Writer로 승격하는 방법을 사용할수도 있다.

### Reader Replica

Reader는 Master `Writer`의 read-only 복사본으로 Master 데이터베이스와 동기화 상태를 유지하고 읽기 전용 쿼리를 처리하여 Master 데이터베이스의 부하를 줄여줄 수 있다. 글로벌 서비스 시에는 Reader만 따로 해당 지역에 두어 read-only 트래픽을 처리할 수 있다.

또한 Master 데이터베이스가 장애로 다운이 되는 경우 자동으로 Reader Replica를 Master로 승격하도록 RDS가 지원한다.

RDS에서 Reader Replica는 최대 15개까지 지닐 수 있다.

## RDS 보안

Amazon RDS는 기본적으로 Amazon VPC 내에서 다룰 수 있다. VPC를 퍼블릭으로 두어 외부에서도 접근 가능하도록 설정할수도 있지만 일반적으로는 데이터베이스의 보안을 위해 프라이빗 서브넷을 구성하여 설정하는 것이 좋다.

VPC를 활용하여 유저와 애플리케이션의 접근을 효율적으로 관리할 수 있으며 필요시 보안 그룹 `Security Group`을 두어 트래픽 흐름을 조절할 수 있다.

### 암호화

Amazon RDS는 데이터베이스 암호화 기능을 제공한다. RDS 의 암호화된 인스턴스는 데이터 보안을 위한 추가적인 레이어를 제공해 비인가 접근을 차단한다. Amazon RDS 암호화는 클라우드에 배포된 애플리케이션의 데이터 보안 수준을 높이며, 저장 상태 데이터의 암호화 법규에 대한 준수 의무를 효과적으로 지킬 수 있다.

Amazon RDS는 기본적으로 AES-256 암호화 알고리즘이 사용되며 암호화 기능을 사용하면 AWS KMS 내에 RDS를 위한 키가 생성되어 RDS 인스턴스의 데이터 암호화 및 복호화에 사용할 수 있다.

Amazon RDS의 데이터베이스 암호화에는 다음 항목에 대한 암호화가 포함된다.

- 데이터베이스 인스턴스 스토리지 암호화
- 자동화된 백업 암호화
- 마스터 데이터베이스의 읽기 사본 암호화
- 마스터 데이터베이스의 스탠바이 데이터베이스 암호화
- 데이터베이스로 생성한 스냅삿 암호화

> 참고로 Oracle과 SQL Server의 경우 데이터베이스 엔진에서 기본으로 제공하는 암호화 방식인 Transparent Database Encyption `TDE`를 사용하더라도 Amazon RDS의 암호화 기능을 사용할수는 있지만 RDS가 제공하는 암호화나 TDE 중 하나를 선택해야한다. 그렇지 않으면 성능 저하가 나타날 수 있다.

### 암호화 주의사항

- Amazon RDS DB 인스턴스에 대한 암호화는 암호화를 생성할 때에만 활성화할 수 있으며 DB 인스턴스가 생성된 후에는 불가능하다.

다만 암호화되지 않은 스냅샷의 사본을 암호화할 수 있기 때문에 암호화되지 않은 DB 인스턴스에 실질적으로 암호화를 추가할 수는 있다. 즉, DB 인스턴스의 스냅샷을 만든 다음 해당 스냅샷의 암호화된 사본을 만들 수 있다. 그런 다음 암호화된 스냅샷에서 DB 인스턴스를 복구할 수 있고, 원본 DB 인스턴스의 암호화된 사본이 생긴다.
- 암호화된 DB 인스턴스의 암호화를 비활성화할 수 없다.
- 암호화되지 않은 DB 인스턴스의 암호화된 스냅샷은 생성할 수 없다.
- 암호화된 DB 인스턴스의 스냅샷은 DB 인스턴스와 동일한 CMK를 사용하여 암호화해야 한다.
- 암호화되지 않은 DB 인스턴스의 암호화된 읽기 전용 복제본이나 암호화된 DB 인스턴스의 암호화되지 않은 읽기 전용 복제본은 보유할 수 없다.
- 암호화된 읽기 전용 복제본이 원본 DB 인스턴스와 동일한 AWS 리전에 있는 경우 해당 인스턴스와 동일한 CMK를 사용하여 암호화해야 한다.
- 암호화된 백업 또는 스냅샷을 암호화된 DB 인스턴스로 복원할 수 없다.
- 암호화된 스냅샷을 한 AWS 리전에서 다른 리전으로 복사하려면 대상 AWS 리전에 CMK를 지정해야 한다. 이는 CMK가 생성된 AWS 리전에만 해당하기 때문이다.
- 암호화된 DB 인스턴스의 암호화를 해제할 수 없다. 하지만 암호화된 DB 인스턴스에서 데이터를 내보내고 암호화되지 않은 DB 인스턴스로 해당 데이터를 가져올 수 있다.

## 백업, 복구, 스냅샷

- 백업

    Amazon RDS 엔진은 하루 한 번의 백업을 실행한다. 

    사용자는 필요에 따라 백업 윈도우의 일정을 조절할 수 있고, 백업이 완벽하게 잘 끝났는지 확인하기 위해 백업 과정을 모니터링할 수 있다. 백업 항목에는 전 체 데이터베이스, 전송 로그, 변경 로드 등이 포함된다. 백업 보존 기간은 35일이며, 서포트 티켓을 이용해 백업 보존 기간을 늘릴 수 있다. 사용자가 인스턴스를 배포한 AZ 마다 다수의 백업 복사본이 유지된다.

    Aurora의 경우 S3 버킷에 자동으로, 지속적으로 백업이 저장되므로 사용자는 별도의 백업 작업을 할 필요가 없지만, 필요시 언제든 수동으로 백업을 생성할 수 있다. Aurora도 마찬가지로 35일 간 백업 보존 기간을 가지며 서포트 티켓으로 기간을 늘릴 수 있다.

- 복구

    백업에서 데이터베이스를 복구하는 경우 기존 데이터베이스와 동일한 복사본을 사용하거나 기존에 존재하는 데이터베이스에 복제를 할 수 있다.

- 스냅샷

    백업의 또 다른 방법으로 스냅샷 기능이 있다. 참고로 스냅샷은 자동으로 관리할 수 없기 때문에 수동으로 직접 생성해야한다.

    스냅샷 생성시에는 임시 I/O 처리를 제공하기 때문에 I/O 처리량이 많은 때에 스냅샷 생성은 자제해야한다.

    스냅샷은 S3에 생성되며 사용자는 이를 통해 데이터베이스를 복원할 수 있다.

## 모니터링

Amazon RDS는 모든 성능 지표를 Amazon CloudWatch를 통해 전송하고 이를 AWS 콘솔에서 확인할 수 있다.

기본적으로는 표준 모니터링 기능으로 15~18개의 지표를 모니터링할 수 있다. CPU 사용량, 메모리, 스왑 사용량, I/O, 쿼리 지연 등의 지표를 모니터링할 수 있다. 사용자는 1분 간격으로 지표를 갱신하여 볼 수 있다.

표준 모니터링 기능에서 더 세분화된 지표를 보고 싶을 수 있다. 이를 위해서 강화된 모니터링 `Enhanced Monitoring`을 지원한다. 표준 모니터링의 지표를 포함해 총 50개의 지표를 볼 수 있다. 1초 주기로 성능 지표를 갱신하며 RDS를 지원하는 모든 RDBMS 엔진에서 사용할 수 있다.

Amazon RDS 주요 모니터링 정보: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/accessing-monitoring.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/accessing-monitoring.html)

> 모니터링 관련하여 Amazon RDS 권장사항을 AWS 콘솔에서 확인할 수 있다. 또한 권장 사항을 즉시 조치하도록 설정할 수 있다.

### 퍼포먼스 인사이트

Amazon RDS의 모니터링 기능을 확장하여 데이터베이스의 성능을 시각화해 성능에 영향을 끼치는 요소를 분석하는데 도움을 주는 기능이다.

퍼포먼스 인사이트 대시보드에서 데이터베이스의 워크로드를 시각화하고 대기상태, SQL 명령, 호스트, 유저 등의 워크로드를 필터링 할 수 있도록 기능을 제공한다.

퍼포먼스 인스턴스의 성능 데이터는 35일간 보존된다.

> Aurora Postgresql 엔진에서는 기본적으로 퍼포먼스 인사이트 기능을 제공한다.
